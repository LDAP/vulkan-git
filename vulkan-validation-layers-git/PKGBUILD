# _     _            _        _          _____
#| |__ | | __ _  ___| | _____| | ___   _|___ /
#| '_ \| |/ _` |/ __| |/ / __| |/ / | | | |_ \
#| |_) | | (_| | (__|   <\__ \   <| |_| |___) |
#|_.__/|_|\__,_|\___|_|\_\___/_|\_\\__, |____/
#                                  |___/

#Maintainer: blacksky3 <https://github.com/blacksky3>
#Credits: Laurent Carlier <lordheavym@gmail.com>

pkgname=vulkan-validation-layers-git
pkgdesc='Vulkan Validation Layers (git version)'
pkgver=1.3.262.r32.g637dd02
pkgrel=1
arch=(x86_64)
url='https://github.com/KhronosGroup/Vulkan-ValidationLayers'
license=(Apache-2.0)
makedepends=(cmake python-lxml libxrandr wayland git make)
depends=(gcc-libs vulkan-icd-loader vulkan-headers libx11)
conflicts=(vulkan-validation-layers)
provides=(vulkan-validation-layers vulkan-validation-layers-git libVkLayer_khronos_validation.so)
options=(!lto !strip) # disable LTO (https://github.com/KhronosGroup/Vulkan-ValidationLayers/issues/5994)
source=(git+https://github.com/KhronosGroup/Vulkan-ValidationLayers.git)

pkgver(){
  cd "${srcdir}"/Vulkan-ValidationLayers

  # cutting off 'foo-' prefix that presents in the git tag
  git describe --long --tags --abbrev=7 --exclude sdk-* | sed 's/^v//;s/\([^-]*-g\)/r\1/;s/-/./g'
}

#prepare(){
#  cd "${srcdir}"/Vulkan-ValidationLayers
#
#  #rm -rf {glslang,Vulkan-Headers,SPIRV-Headers,SPIRV-Tools,robin-hood-hashing,googletest}
#
#  #sed -i s'/"commit": "release-1.8.1",/"commit": "release-1.11.0",/' scripts/known_good.json
#
#  ./scripts/update_deps.py
#}

build(){
  rm -rf "${srcdir}"/build

  "${srcdir}"/Vulkan-ValidationLayers/scripts/update_deps.py

  cmake -C helper.cmake -B "${srcdir}"/build -S "${srcdir}"/Vulkan-Headers \
  -G "Unix Makefiles" \
  -D CMAKE_BUILD_TYPE=Release \
  -D CMAKE_INSTALL_PREFIX=/usr \
  -D CMAKE_INSTALL_LIBDIR=lib \
  -D CMAKE_INSTALL_SYSCONFDIR=/etc \
  -D CMAKE_INSTALL_DATADIR=/share \
  -D CMAKE_INSTALL_INCLUDEDIR="/usr/include/" \
  -D BUILD_LAYERS=ON \
  -D BUILD_LAYER_SUPPORT_FILES=ON \
  -D CMAKE_SKIP_RPATH=True \
  -D BUILD_TESTS=OFF \
  -D BUILD_WSI_XCB_SUPPORT=On \
  -D BUILD_WSI_XLIB_SUPPORT=On \
  -D BUILD_WSI_WAYLAND_SUPPORT=On \
  -D USE_ROBIN_HOOD_HASHING=OFF \
  -Wno-dev

  make -j$(nproc) -C "${srcdir}"/build
}

package(){
  make -j$(nproc) -C "${srcdir}"/build DESTDIR="${pkgdir}" install

  # install doc
  install -dm755 "${pkgdir}"/usr/share/doc/"${pkgname}"/
  cp -r "${srcdir}"/Vulkan-ValidationLayers/docs/* "${pkgdir}"/usr/share/doc/"${pkgname}"/

  # install licence
  install -dm755 "${pkgdir}"/usr/share/licenses/"${pkgname}"
  install -m644 "${srcdir}"/Vulkan-ValidationLayers/LICENSE.txt "${pkgdir}"/usr/share/licenses/"${pkgname}"/
}

sha256sums=('SKIP')

# vim:set ts=8 sts=2 sw=2 et:
